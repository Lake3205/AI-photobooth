stages:
  - deploy

test_ssh:
  stage: deploy
  tags:
    - hva
  image: ubuntu:latest
  before_script:
    - apt-get update && apt-get install -y openssh-client
  script:
    - echo "$VPS_SSH_KEY" > id_rsa
    - chmod 600 id_rsa
    - ssh -v -o StrictHostKeyChecking=no -i id_rsa root@185.228.82.235 "echo 'âœ… Verbinding gelukt!'"
    - rm id_rsa
  rules:
    - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "dev"'
      when: manual
    - when: never

deploy_dev:
  stage: deploy
  tags:
    - hva
  image: ubuntu:latest
  before_script:
    - apt-get update && apt-get install -y openssh-client
  script:
    - echo "$VPS_SSH_KEY" > id_rsa
    - chmod 600 id_rsa
    - ssh -o StrictHostKeyChecking=no -i id_rsa root@185.228.82.235 '
        docker stop frontend-dev || true &&
        docker rm frontend-dev || true &&
        docker run -d --name frontend-dev -p 3001:3000 dark-tech-frontend:dev &&
        docker stop backend-dev || true &&
        docker rm backend-dev || true &&
        docker run -d --name backend-dev -p 8001:8000 dark-tech-backend:dev
      '
    - rm id_rsa
  rules:
    - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "dev"'
      when: manual
    - when: never

deploy_main:
  stage: deploy
  tags:
    - hva
  image: ubuntu:latest
  before_script:
    - apt-get update && apt-get install -y openssh-client
  script:
    - echo "$VPS_SSH_KEY" > id_rsa
    - chmod 600 id_rsa
    - ssh -o StrictHostKeyChecking=no -i id_rsa root@185.228.82.235 '
        docker stop frontend-main || true &&
        docker rm frontend-main || true &&
        docker run -d --name frontend-main -p 3000:3000 dark-tech-frontend:main &&
        docker stop backend-main || true &&
        docker rm backend-main || true &&
        docker run -d --name backend-main -p 8000:8000 dark-tech-backend:main
      '
    - rm id_rsa
  rules:
    - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"'
      when: manual
    - when: never
