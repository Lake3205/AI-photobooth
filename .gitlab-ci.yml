stages:
  - test
  - build
  - deploy

build_dev:
  stage: build
  tags:
    - hva
  image:
    name: emetain/kaniko-wrapper:latest
    entrypoint: [ "" ]
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
      when: always
    - when: never
  variables:
    DOCKER_CONFIG: /kaniko/.docker/
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"https://index.docker.io/v1/\":{\"username\":\"$DOCKER_USERNAME\",\"password\":\"$DOCKER_PASSWORD\"}}}" > /kaniko/.docker/config.json

    - >
      /kaniko/executor
      --context ./frontend
      --dockerfile ./frontend/Dockerfile
      --destination emetain/dark-tech-frontend-dev:dev

    - >
      /kaniko/executor
      --context ./backend
      --dockerfile ./backend/Dockerfile
      --destination emetain/dark-tech-backend-dev:dev

deploy_dev:
  stage: deploy
  needs:
    - job: build_dev
  tags:
    - hva
  image: ubuntu:latest
  before_script:
    - apt-get update && apt-get install -y openssh-client
  script:
    - echo "$VPS_SSH_KEY" | tr -d '\r' > id_rsa
    - chmod 400 id_rsa
    - ssh -o StrictHostKeyChecking=no -i id_rsa root@185.228.82.235 "
      docker pull ${DOCKER_USERNAME}/dark-tech-frontend-dev:dev &&
      docker pull ${DOCKER_USERNAME}/dark-tech-backend-dev:dev &&
      cd /home/dark-tech &&
      docker image prune -f &&
      docker compose -f docker-compose.dev.yml up -d --force-recreate
      "
    - rm id_rsa
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
      when: always
    - when: never

build_main:
  stage: build
  tags:
    - hva
  image: emetain/kaniko-wrapper:latest
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always
    - when: never
  variables:
    DOCKER_CONFIG: /kaniko/.docker/
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"https://index.docker.io/v1/\":{\"username\":\"$DOCKER_USERNAME\",\"password\":\"$DOCKER_PASSWORD\"}}}" > /kaniko/.docker/config.json

    # Create .env.production from GitLab CI/CD variables
    - echo "GEMINI_API_KEY=${PROD_GEMINI_API_KEY}" > .env.production
    - echo "CLAUDE_API_KEY=${PROD_CLAUDE_API_KEY}" >> .env.production
    - echo "DB_HOST=${PROD_DB_HOST}" >> .env.production
    - echo "DB_PORT=${PROD_DB_PORT}" >> .env.production
    - echo "DB_USER=${PROD_DB_USER}" >> .env.production
    - echo "DB_PASSWORD=${PROD_DB_PASSWORD}" >> .env.production
    - echo "DB_NAME=${PROD_DB_NAME}" >> .env.production
    - echo "JWT_SECRET_KEY=${PROD_JWT_SECRET_KEY}" >> .env.production
    - echo "VITE_API_URL=${PROD_VITE_API_URL}" >> .env.production
    - echo "VITE_ENV=production" >> .env.production

    - >
      /kaniko/executor
      --context ./frontend
      --dockerfile ./frontend/Dockerfile
      --build-arg ENV_FILE=.env.production
      --destination emetain/dark-tech-frontend:latest

    - >
      /kaniko/executor
      --context ./backend
      --dockerfile ./backend/Dockerfile
      --build-arg ENV_FILE=.env.production
      --destination emetain/dark-tech-backend:latest

deploy_main:
  stage: deploy
  needs:
    - job: build_main
  image: ubuntu:latest
  tags:
    - hva
  before_script:
    - apt-get update && apt-get install -y openssh-client
  script:
    - echo "$VPS_SSH_KEY" | tr -d '\r' > id_rsa
    - chmod 400 id_rsa
    - ssh -o StrictHostKeyChecking=no -i id_rsa root@185.228.82.235 "
      docker pull ${DOCKER_USERNAME}/dark-tech-frontend:latest &&
      docker pull ${DOCKER_USERNAME}/dark-tech-backend:latest &&
      cd /home/dark-tech &&
      docker image prune -f &&
      docker compose -f docker-compose.prod.yml up -d --force-recreate
      "
    - rm id_rsa
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always
    - when: never

test_build:
  stage: test
  allow_failure: true
  tags:
    - hva
  image:
    name: emetain/kaniko-wrapper:latest
    entrypoint: [ "" ]
  rules:
    - if: '$CI_MERGE_REQUEST_ID && ($CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "dev" || $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main")'
      when: always
    - when: never

  variables:
    DOCKER_CONFIG: /kaniko/.docker/
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"https://index.docker.io/v1/\":{\"username\":\"$DOCKER_USERNAME\",\"password\":\"$DOCKER_PASSWORD\"}}}" > /kaniko/.docker/config.json

    - >
      /kaniko/executor
      --context ./frontend
      --dockerfile ./frontend/Dockerfile
      --destination dummy/frontend:test
      --no-push

    - >
      /kaniko/executor
      --context ./backend
      --dockerfile ./backend/Dockerfile
      --destination dummy/backend:test
      --no-push

