stages:
  - build
  - deploy

build_dev:
  stage: build
  tags:
    - hva
  image: gcr.io/kaniko-project/executor:latest
  rules:
    - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "dev"'
  variables:
    DOCKER_CONFIG: /kaniko/.docker/
  script:
    - >
      /kaniko/executor
      --context ./frontend
      --dockerfile ./frontend/Dockerfile
      --destination ${DOCKER_USERNAME}/dark-tech-frontend-dev:dev

    - >
      /kaniko/executor
      --context ./backend
      --dockerfile ./backend/Dockerfile
      --destination ${DOCKER_USERNAME}/dark-tech-backend-dev:dev

deploy_dev:
  stage: deploy
  needs:
    - job: build_dev
  tags:
    - hva
  image: ubuntu:latest
  before_script:
    - apt-get update && apt-get install -y openssh-client
  script:
    - echo "$VPS_SSH_KEY" | tr -d '\r' > id_rsa
    - chmod 400 id_rsa
    - ssh -o StrictHostKeyChecking=no -i id_rsa root@185.228.82.235 "
        docker pull ${DOCKER_USERNAME}/dark-tech-frontend-dev:dev &&
        docker pull ${DOCKER_USERNAME}/dark-tech-backend-dev:dev &&
        cd /home/dark-tech &&
        docker-compose -f docker-compose.dev.yml up -d --remove-orphans
      "
    - rm id_rsa
  rules:
    - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "dev"'
      when: always
    - when: never

build_main:
  stage: build
  tags:
    - hva
  image: gcr.io/kaniko-project/executor:latest
  rules:
    - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"'
  variables:
    DOCKER_CONFIG: /kaniko/.docker/
  script:
    - >
      /kaniko/executor
      --dockerfile=./frontend/Dockerfile
      --context=./frontend
      --destination=${DOCKER_USERNAME}/dark-tech-frontend:main
      --verbosity=info
      --skip-unused-stages
      --single-snapshot
      --insecure
      --insecure-pull
      --insecure-registry
      --cache=true
      --cache-repo=${DOCKER_USERNAME}/dark-tech-frontend-cache
      --build-arg=DOCKER_USERNAME=${DOCKER_USERNAME}
      --build-arg=DOCKER_PASSWORD=${DOCKER_PASSWORD}
      --custom-platform=linux/amd64
      --log-format=text
      --snapshotMode=redo
      --use-new-run
      --context-sub-path=frontend
      --destination=${DOCKER_USERNAME}/dark-tech-frontend:main
      --oci-layout-path=/kaniko/oci-layout
      --tar-path=/kaniko/image.tar
      --push-image=true
      --cleanup

    - >
      /kaniko/executor
      --dockerfile=./backend/Dockerfile
      --context=./backend
      --destination=${DOCKER_USERNAME}/dark-tech-backend:main
      --verbosity=info
      --skip-unused-stages
      --single-snapshot
      --insecure
      --insecure-pull
      --insecure-registry
      --cache=true
      --cache-repo=${DOCKER_USERNAME}/dark-tech-backend-cache
      --build-arg=DOCKER_USERNAME=${DOCKER_USERNAME}
      --build-arg=DOCKER_PASSWORD=${DOCKER_PASSWORD}
      --custom-platform=linux/amd64
      --log-format=text
      --snapshotMode=redo
      --use-new-run
      --context-sub-path=backend
      --destination=${DOCKER_USERNAME}/dark-tech-backend:main
      --oci-layout-path=/kaniko/oci-layout
      --tar-path=/kaniko/image.tar
      --push-image=true
      --cleanup

deploy_main:
  stage: deploy
  needs:
    - job: build_main
  image: ubuntu:latest
  tags:
    - hva
  before_script:
    - apt-get update && apt-get install -y openssh-client
  script:
    - echo "$VPS_SSH_KEY" | tr -d '\r' > id_rsa
    - chmod 400 id_rsa
    - ssh -o StrictHostKeyChecking=no -i id_rsa root@185.228.82.235 "
        docker pull ${DOCKER_USERNAME}/dark-tech-frontend:latest &&
        docker pull ${DOCKER_USERNAME}/dark-tech-backend:latest &&
        cd /home/dark-tech &&
        docker-compose -f docker-compose.prod.yml up -d --remove-orphans
      "
    - rm id_rsa
  rules:
    - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"'
      when: always
    - when: never

.test_connection_template: &test_connection
  stage: deploy
  tags:
    - hva
  image: ubuntu:latest

  before_script:
    - apt-get update && apt-get install -y openssh-client

  script:
    - echo "$VPS_SSH_KEY" > id_rsa
    - chmod 400 id_rsa
    - ssh -v -o StrictHostKeyChecking=no -i id_rsa root@185.228.82.235 "echo 'âœ… SSH connection successful!'"
    - rm id_rsa

test_ssh:
  <<: *test_connection
  rules:
    - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "dev"'
      when: manual
    - when: never